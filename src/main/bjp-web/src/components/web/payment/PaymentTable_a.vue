<template>
  <div class="paymentTable_1a">
    <div class="q-table_wrap">
      <div class="q-table_header_wrap">
        <div class="q-table_header_title">
          <p>ì¹´ë“œê²°ì œ</p>
        </div>
      </div>
      <div class="paySub_header_wrap">
        <div class="paySub_left">
          <div class="payby_wrap">
            <div class="payby_title">
              <p>ê²°ì œë°©ë²•</p>
            </div>
            <div class="payby_radio">
              <!-- <RadioComp_a
                v-model="paybyRadio"
                :radio_options="paybyRadioOptions"
                @update:model-value="onChangePaybyRadio"
              /> -->
              <div>
                <q-option-group
                  v-model="paybyRadio"
                  :options="filteredPaybyRadioOptions"
                  color="blue-10"
                  size="xs"
                  inline
                  dense
                  @update:model-value="onChangePaybyRadio"
                />
              </div>
            </div>
          </div>
          <div v-if="paybyRadio === '1'" class="payby_card">
            <div class="payby_title">
              <p>ì¹´ë“œì„ íƒ</p>
            </div>
            <div class="card_select_wrap slct-wrap">
              <!-- <SelectComp_default
                :selectModel="selectModel"
                :selectOption="selectOption"
              /> -->
              <q-select
                v-model="selectCard"
                class="select_default"
                :options="cardListOptions"
                borderless
                dense
                emit-value
                map-options
                @update:model-value="onUpdate"
              />
            </div>
            <!--<BtnComp_default btnLabel="ì¹´ë“œì„ íƒ" @click="onClickSelectCard" /> -->
          </div>
        </div>
        <div class="paySub_right">
          <BtnComp_br
            btn_br_link="/mycard"
            btn_br_top="ë‚˜ì˜"
            btn_br_bottom="ì¹´ë“œì •ë³´"
          />
          <BtnComp_br_purple btn_br_top="ì¹´ë“œíšŒì‚¬" btn_br_bottom="ê³µì§€ì‚¬í•­">
            <q-tooltip anchor="top right" self="top left">
              <p style="font-size: 14px; margin-bottom: 20px">
                &#60;ì‹ í•œì¹´ë“œ ê²°ì œ ê´€ë ¨ ê³µì§€ì‚¬í•­&#62;<br />
                ì‹ í•œì¹´ë“œì‚¬ì—ì„œ ìµœê·¼ ë‹¹ì‚¬ë¡œ ê³µë¬¸ì„ ë³´ë‚´ì™€, íŠ¹ì •ì¹´ë“œì˜
                íŠ¹ì •ê¸ˆì•¡(5,999ì› ë“±) <br />
                ê±°ë˜ë¥¼ ë¹„ì •ìƒ ê±°ë˜ë¡œ ê·œì •í•˜ê³  í•´ë‹¹ ê±°ë˜ì˜ ì¦‰ì‹œ ì¤‘ë‹¨ ë° ì†Œëª…ìë£Œ
                ì œì¶œì„ ìš”ì²­í•˜ì˜€ìŠµë‹ˆë‹¤. <br />
                ë˜í•œ ë™ì¼ ìœ í˜•ì˜ ê±°ë˜ê°€ ì§€ì† ë°œìƒë  ê²½ìš° ê±°ë˜ì •ì§€ ë“±ì˜ ì¡°ì¹˜ê°€
                ì·¨í•´ì§ˆ ìˆ˜ ìˆë‹¤ê³  ì•Œë ¤ ì™”ìŠµë‹ˆë‹¤. <br />
                ë”°ë¼ì„œ ì•½í’ˆëŒ€ê¸ˆì„ ì†Œì•¡ ë‹¤ê±´ìœ¼ë¡œ ê²°ì œ(5,999ì› ë“±)í•´ ì˜¤ì…¨ë˜
                ê²½ìš°ì—ëŠ” <br />
                í–¥í›„ ì†Œì•¡ ë‹¤ê±´ ê²°ì œì˜ ì¤‘ì§€ë¥¼ ìš”ì²­ë“œë¦½ë‹ˆë‹¤. <br />
                ì‹ í•œì¹´ë“œì˜ ê²½ìš° ìµœì†Œê²°ì œ ê°€ëŠ¥ ê¸ˆì•¡ì„ 5ë§Œì›ìœ¼ë¡œ ì¡°ì •í•˜ì˜€ìŠµë‹ˆë‹¤.
                ê°ì‚¬í•©ë‹ˆë‹¤.<br />
              </p>
              <p style="font-size: 14px">
                â€» ì¹´ë“œê²°ì œí•œ ê¸ˆì•¡ì€ 2~3ì¼ í›„ì—(ì£¼ë§ì œì™¸) ì…ê¸ˆ í™•ì¸ í›„ ì”ê³ ì—
                ë°˜ì˜ë©ë‹ˆë‹¤. <br />
                "ì¹´ë“œë²ˆí˜¸ì™€ ìœ íš¨ê¸°ê°„ì„ ì˜ëª» ì…ë ¥í•˜ì—¬ íƒ€ì¸ì˜ ì¹´ë“œë¡œ ê²°ì œê°€
                ë¨ìœ¼ë¡œì¨ <br />
                ë‹¹ì‚¬ë¡œ í•­ì˜ì „í™”ê°€ ì˜¤ëŠ” ì‚¬ë¡€ê°€ ìˆìŠµë‹ˆë‹¤. <br />
                ì´ê²½ìš° ì¹´ë“œë²ˆí˜¸ë‚˜ ìœ íš¨ê¸°ê°„ì„ ì˜ëª» ì…ë ¥í•œ ê°œì¸ì—ê²Œ í˜•ì‚¬ì  ë¯¼ì‚¬ì 
                ì±…ì„ì´ ìˆìœ¼ë¯€ë¡œ <br />
                ì¹´ë“œë²ˆí˜¸ì™€ ìœ íš¨ê¸°ê°„ì„ ë‹¤ì‹œí•œë²ˆ í™•ì¸í•˜ì‹  í›„ ê²°ì œ ì§„í–‰í•˜ì‹œê¸°
                ë°”ëë‹ˆë‹¤."
              </p>
            </q-tooltip>
          </BtnComp_br_purple>
        </div>
      </div>

      <div class="paymentTable_wrap">
        <div class="cardWrap">
          <dl>
            <dt></dt>
            <dd>
              <q-option-group
                v-if="paybyRadio === '1'"
                v-model="cardInfo.cardGb"
                :options="filteredcardGbOptions"
                color="blue-10"
                size="xs"
                inline
                dense
                :disable="isDisable"
              />
              <q-option-group
                v-if="paybyRadio === '2'"
                v-model="cardInfo.simplCardGb"
                :options="simplPmntGbOptions"
                color="blue-10"
                size="xs"
                inline
                dense
              />
            </dd>
          </dl>
          <dl v-if="paybyRadio === '1'" class="card_num">
            <dt>ì¹´ë“œë²ˆí˜¸</dt>
            <dd>
              <q-input
                ref="card1"
                v-model="cardInfo.cardNo1"
                input-class="input_default "
                borderless
                dense
                maxlength="4"
                mask="####"
                :disable="isDisable"
                @update:model-value="autoMove($event, 4, 'card1')"
              />-
              <q-input
                ref="card2"
                v-model="cardInfo.cardNo2"
                input-class="input_default"
                borderless
                dense
                maxlength="4"
                type="password"
                mask="####"
                :disable="isDisable"
                @update:model-value="autoMove($event, 4, 'card2')"
              />-
              <q-input
                ref="card3"
                v-model="cardInfo.cardNo3"
                input-class="input_default"
                borderless
                dense
                maxlength="4"
                type="password"
                mask="####"
                :disable="isDisable"
                @update:model-value="autoMove($event, 4, 'card3')"
              />-
              <q-input
                ref="card4"
                v-model="cardInfo.cardNo4"
                input-class="input_default"
                borderless
                dense
                maxlength="4"
                mask="####"
                :disable="isDisable"
                @update:model-value="autoMove($event, 4, 'card4')"
              />
            </dd>
          </dl>
          <dl v-if="paybyRadio === '1'">
            <dt>ìœ íš¨ê¸°ê°„</dt>
            <dd>
              <q-input
                ref="cardMonth"
                v-model="cardInfo.cardM"
                input-class="input_default"
                borderless
                dense
                style="width: 40px"
                mask="##"
                placeholder="MM"
                :disable="isDisable"
                @update:model-value="autoMove($event, 2, 'cardMonth')"
              />/
              <q-input
                ref="cardYear"
                v-model="cardInfo.cardY"
                input-class="input_default"
                borderless
                dense
                style="width: 40px"
                mask="##"
                placeholder="YY"
                :disable="isDisable"
                @update:model-value="autoMove($event, 2, 'cardYear')"
              />
            </dd>
            <dt v-if="cardInfo.cardGb === 'INICIS' && userInfo.BRCH_CD != '53'">
              ê°œì¸ì¹´ë“œ/ê¸°ì—…ì¹´ë“œ
            </dt>
            <dd v-if="cardInfo.cardGb === 'INICIS' && userInfo.BRCH_CD != '53'">
              <q-input
                v-model="cardInfo.birthDt"
                input-class="input_default"
                mask="##########"
                borderless
                dense
              />
            </dd>
          </dl>
          <dl
            v-if="cardInfo.cardGb === 'INICIS' && userInfo.BRCH_CD != '53'"
            class="card_alert"
          >
            <dt></dt>
            <dd></dd>
            <dd>
              <span
                >â˜…ê°œì¸ì¹´ë“œ : ìƒë…„ì›”ì¼(6ìë¦¬) ì…ë ¥<br />
                â˜…ê¸°ì—…ì¹´ë“œ : ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸(10ìë¦¬) ì…ë ¥</span
              >
            </dd>
          </dl>
          <dl v-if="paybyRadio === '1'">
            <dt>í• ë¶€</dt>
            <dd>
              <div class="slct-wrap">
                <q-select
                  ref="cardIns"
                  v-model="cardInfo.ins"
                  class="select_default"
                  :options="monthOption"
                  style="background-color: #fff"
                  borderless
                  dense
                  emit-value
                  map-options
                />
              </div>
            </dd>
            <dt v-if="selectCard !== 0">ë¹„ë°€ë²ˆí˜¸</dt>
            <dd v-if="selectCard !== 0" class="flex_start">
              <!-- <InputComp_password
                  v-model="cardInfo.pwd"
                  style="width: 80px"
                /> -->
              <q-input
                v-model="cardInfo.pwd"
                input-class="input_default"
                borderless
                dense
                type="password"
              />
            </dd>
          </dl>
          <div class="btnArea">
            <BtnComp_default btnLabel="ê²°ì œ" @click="onClickPayment" />
          </div>
        </div>
      </div>
    </div>
  </div>
  <form id="creditForm">
    <input type="hidden" name="custCd" :value="cardInfo.custCd" />
    <input type="hidden" name="brchCd" :value="cardInfo.brchCd" />
    <input type="hidden" name="CARD_GB" :value="cardInfo.simplCardGb" />
    <input type="hidden" name="g_CARDCODE" :value="cardInfo.g_CARDCODE" />
    <input type="hidden" name="g_amountTi" :value="cardInfo.g_amountTi" />
    <input type="hidden" name="CARD_GB" :value="cardInfo.simplCardGb" />
    <input
      type="hidden"
      name="PAYMENT_AMOUNT_TI"
      :value="cardInfo.paymentAmountTi"
    />
  </form>
  <form id="kakaoPayForm">
    <input type="hidden" name="custCd" :value="cardInfo.custCd" />
    <input type="hidden" name="CARD_GB" :value="cardInfo.simplCardGb" />
    <input type="hidden" name="g_CARDCODE" :value="cardInfo.g_CARDCODE" />
    <input type="hidden" name="g_amountTi" :value="cardInfo.g_amountTi" />
    <input type="hidden" name="CARD_GB" :value="cardInfo.simplCardGb" />
    <input
      type="hidden"
      name="PAYMENT_AMOUNT_TI"
      :value="cardInfo.paymentAmountTi"
    />
  </form>
  <q-form
    id="kakaoForm"
    action="http://localhost:1010/inicis/reqPayment"
    method="post"
    target="PayForm"
  >
    <input type="hidden" name="price" :value="cardInfo.paymentAmountTi" />
    <input
      type="hidden"
      name="buyertel"
      :value="userInfo.HP_NO_CUST.replaceAll('-', '')"
    />
    <input type="hidden" name="goodname" value="ë°±ì œì•½í’ˆ" />
    <input type="hidden" name="gopaymethod" value="onlykakaopay" />
    <input type="hidden" name="acceptmethod" value="cardonly" />
  </q-form>
  <!-- <iframe
    id="PayForm"
    name="PayForm"
    style="display: block; width: 80vw; height: 80vh; border: none"
  ></iframe> -->
</template>

<script setup>
//---------------------- Import & Declaration ------------------------//

import { ref, computed, onMounted, inject, watch } from "vue";
import { api } from "boot/axios";
import * as util from "src/support/util";
import { useRoute, useRouter } from "vue-router";

import BtnComp_default from "src/components/web/common/BtnComp_default.vue";
import SelectComp_default from "src/components/web/common/SelectComp_default.vue";
import RadioComp_a from "src/components/web/common/RadioComp_a.vue";
import BtnComp_br from "src/components/web/common/BtnComp_br.vue";
import BtnComp_br_purple from "src/components/web/common/BtnComp_br_purple.vue";
import InputComp_default from "src/components/web/common/InputComp_default.vue";
import InputComp_password from "src/components/web/common/InputComp_password.vue";

const route = useRoute();
const router = useRouter();
const userInfo = util.getUserData();
const bus = inject("bus");
const selectCard = ref(0);
const cardListOptions = ref([]);

const paybyRadio = ref("1");
bus.on("pmntAmt", (data) => {
  const num = Number(String(data).replace(/,/g, ""));
  cardInfo.value.paymentAmountTi = num;
});
const paybyRadioOptions = [
  {
    label: "ì¼ë°˜ê²°ì œ",
    value: "1",
  },
  {
    label: "ì¹´ë“œ ê°„í¸ê²°ì œ",
    value: "2",
  },
];
// ğŸ” userInfo.BRCH_CD ê°’ì— ë”°ë¼ ì˜µì…˜ì„ í•„í„°ë§í•˜ì—¬ ì œê³µ
const filteredPaybyRadioOptions = computed(() => {
  const restrictedBranches = ["53", "58", "59", "61"];

  if (restrictedBranches.includes(userInfo.BRCH_CD)) {
    // ì¹´ë“œ ê°„í¸ê²°ì œ ì˜µì…˜ì„ ì œì™¸ (valueê°€ '2'ì¸ í•­ëª©ì„ í•„í„°ë§)
    return paybyRadioOptions.filter((option) => option.value !== "2");
  }
  return paybyRadioOptions;
});
const cardInfo = ref({
  userId: userInfo.USER_ID,
  custCd: userInfo.CUST_CD,
  brchCd: userInfo.BRCH_CD,
  cardGb: "",
  simplCardGb: "",
  ins: "",
  cardNo1: "",
  cardNo2: "",
  cardNo3: "",
  cardNo4: "",
  cardNo: "",
  birthDt: "",
  cardM: "",
  cardY: "",
  paymentAmountTi: "",
  pwd: "",
  expYy: "",
  expMm: "",
  g_CARDCODE: "",
  g_amountTi: "",
});

const cardGbOptions = [
  {
    label: "ì‹ í•œ, ë¡¯ë°, ë¹„ì”¨ (ìµœì†Œê²°ì œ ê°€ëŠ¥ ê¸ˆì•¡: 5ë§Œì›)",
    value: "INICIS",
  },
  {
    label: "ì‚¼ì„±, í˜„ëŒ€, êµ­ë¯¼",
    value: "PHARMPAY",
  },
];
// âœ… ì˜µì…˜ í•„í„°ë§ ë¡œì§ (ì¡°ê±´ì— ë”°ë¼ ë™ì ìœ¼ë¡œ í‘œì‹œ)
const filteredcardGbOptions = computed(() => {
  const branchCode = userInfo.BRCH_CD;
  const filteredOptions = [];

  // 1. ì‹ í•œ, ë¹„ì”¨ (ì¹´ë“œê²°ì œ1) - ì¡°ê±´ í™•ì¸ í›„ ì¶”ê°€
  if (
    branchCode !== "53" &&
    branchCode !== "58" &&
    branchCode !== "59" &&
    branchCode !== "61"
  ) {
    filteredOptions.push({
      label: "ì‹ í•œ, ë¡¯ë°, ë¹„ì”¨ (ìµœì†Œê²°ì œ ê°€ëŠ¥ ê¸ˆì•¡: 5ë§Œì›)",
      value: "INICIS",
    });
  }

  // 2. ì¹´ë“œê²°ì œ1 í‘œì‹œ (BRCH_CD == '53')
  if (branchCode === "53") {
    filteredOptions.push({ label: "ì¹´ë“œê²°ì œ1", value: "INICIS" });
  }

  // 3. ì‚¼ì„±, í˜„ëŒ€, êµ­ë¯¼ (ì¹´ë“œê²°ì œ2) - ì¡°ê±´ í™•ì¸ í›„ ì¶”ê°€
  if (
    branchCode !== "53" &&
    branchCode !== "58" &&
    branchCode !== "59" &&
    branchCode !== "61"
  ) {
    filteredOptions.push({ label: "ì‚¼ì„±, í˜„ëŒ€, êµ­ë¯¼", value: "PHARMPAY" });
  }

  // 4. ì¹´ë“œê²°ì œ2 í‘œì‹œ (BRCH_CD == '53' || '58' || '59' || '61')
  if (["53", "58", "59", "61"].includes(branchCode)) {
    filteredOptions.push({ label: "ì¹´ë“œê²°ì œ2", value: "PHARMPAY" });
  }

  return filteredOptions;
});
const simplPmntGbOptions = [
  {
    label: "ì‹ í•œ, ë¡¯ë°, ë¹„ì”¨(ìµœì†Œê²°ì œ ê°€ëŠ¥ ê¸ˆì•¡: 5ë§Œì›)",
    value: "INICIS_SHINHAN",
  },
  {
    label: "í˜„ëŒ€, ì‚¼ì„±",
    value: "INICIS_ETC",
  },
];

const monthOption = [
  { label: "", value: "-1" },
  { label: "ì¼ì‹œë¶ˆ", value: "00" },
  { label: "2 ê°œì›”", value: "02" },
  { label: "3 ê°œì›”", value: "03" },
  { label: "4 ê°œì›”", value: "04" },
  { label: "5 ê°œì›”", value: "05" },
  { label: "6 ê°œì›”", value: "06" },
  { label: "7 ê°œì›”", value: "07" },
  { label: "8 ê°œì›”", value: "08" },
  { label: "9 ê°œì›”", value: "09" },
  { label: "10 ê°œì›”", value: "10" },
  { label: "11 ê°œì›”", value: "11" },
  { label: "12 ê°œì›”", value: "12" },
];

const searchParam = ref({
  custCd: userInfo.CUST_CD,
  cardNo: "",
  sno: "",
  cardGb: "",
});

const isDisable = computed(() => selectCard.value !== 0);

const card1 = ref(null);
const card2 = ref(null);
const card3 = ref(null);
const card4 = ref(null);
const cardMonth = ref(null);
const cardYear = ref(null);
const cardIns = ref(null);

//---------------------------- Function ------------------------------//

async function fetchData() {
  const res = await api.get("/payment/myCard", {
    params: searchParam.value,
  });

  cardListOptions.value.push({ value: 0, label: "ì§ì ‘ ì…ë ¥" });

  res.forEach((m) => {
    cardListOptions.value.push({
      value: m.SNO,
      label: m.CARD_NM,
    });
  });
}

function onChangePaybyRadio() {
  cardInfo.value.cardGb = "";
  cardInfo.value.simplCardGb = "";

  initCardInfo();
}

// ì¹´ë“œì„ íƒ
// async function onClickSelectCard() {
//   if (selectCard.value === 0) return;

//   searchParam.value.sno = selectCard.value;

//   const res = await api.get("/payment/myCardDtl", {
//     params: searchParam.value,
//   });

//   const cardNoDec = res.CARD_NO;

//   cardInfo.value.cardGb = res.PG_GB;
//   cardInfo.value.cardNo1 = cardNoDec.substr(0, 4);
//   cardInfo.value.cardNo2 = cardNoDec.substr(4, 4);
//   cardInfo.value.cardNo3 = cardNoDec.substr(8, 4);
//   cardInfo.value.cardNo4 = cardNoDec.substr(12, 4);
//   cardInfo.value.cardM = res.EXP_MM;
//   cardInfo.value.cardY = res.EXP_YY;
// }

function initCardInfo() {
  cardInfo.value.cardGb = "";
  cardInfo.value.simplCardGb = "";
  cardInfo.value.ins = "";
  cardInfo.value.cardNo1 = "";
  cardInfo.value.cardNo2 = "";
  cardInfo.value.cardNo3 = "";
  cardInfo.value.cardNo4 = "";
  cardInfo.value.cardNo = "";
  cardInfo.value.cardM = "";
  cardInfo.value.cardY = "";
  cardInfo.value.pwd = "";
  cardInfo.value.expYy = "";
  cardInfo.value.expMm = "";
  cardInfo.value.birthDt = "";
}

//ê°„í¸ê²°ì œ popup
async function makeNewWindow() {
  const frm = document.getElementById("creditForm");
  const url = "/payment/wpaystdPayAuthCardRequest";
  let IFWin;
  const OpenOption =
    "toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=550,height=650,top=100,left=400,";
  document.cookie = "cross-site-cookie=bar; SameSite=None; Secure";
  IFWin = window.open("", "IfWindow", OpenOption);

  frm.action = url; // ê°œë°œ ë° ìš´ì˜ URL - ë¡œì»¬ì—ì„œ í…ŒìŠ¤íŠ¸ì‹œ, í•˜ê¸°ì˜ ë¡œì»¬ URLì„ ì‚¬ìš©í•˜ê±°ë‚˜ vue project ë¹Œë“œ í›„ 1010ìœ¼ë¡œ ì ‘ì†í•˜ì—¬ ì§„í–‰
  //frm.action = "http://localhost:1010/payment/wpaystdPayAuthCardRequest"; // ë¡œì»¬ URL
  frm.target = "IfWindow";
  frm.method = "POST";
  frm.submit();
}

// ê²°ì œ
async function onClickPayment() {
  const cardGb = cardInfo.value.cardGb;
  const simplCardGb = cardInfo.value.simplCardGb;
  const cardNo1 = cardInfo.value.cardNo1;
  const cardNo2 = cardInfo.value.cardNo2;
  const cardNo3 = cardInfo.value.cardNo3;
  const cardNo4 = cardInfo.value.cardNo4;
  const cardM = cardInfo.value.cardM;
  const cardY = cardInfo.value.cardY;
  const paymentAmountTi = cardInfo.value.paymentAmountTi;
  const pwd = cardInfo.value.pwd;
  const birthDt = cardInfo.value.birthDt;
  const cardIns = cardInfo.value.ins;
  //const custCd = cardInfo.value.custCd;

  if (paymentAmountTi === 0) {
    alert("ê²°ì œê¸ˆì•¡ì´ 0ì›ì…ë‹ˆë‹¤.");
    return;
  }

  if (paybyRadio.value !== "3") {
    if (cardGb === "" && simplCardGb === "") {
      alert("ì¹´ë“œì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
      return;
    }

    if (userInfo.BRCH_CD !== "53") {
      if (
        (cardGb === "INICIS" || simplCardGb === "INICIS_SHINHAN") &&
        paymentAmountTi < 50000
      ) {
        alert("ì‹ í•œì¹´ë“œ ìµœì†Œê²°ì œ ê°€ëŠ¥ê¸ˆì•¡ì€ 50,000 ì› ì…ë‹ˆë‹¤.");
        return;
      }
    }

    if (simplCardGb === "INICIS_SHINHAN" || simplCardGb === "INICIS_ETC") {
      if (paymentAmountTi < 10) {
        alert("ê²°ì œê¸ˆì•¡ì€ 10ì› ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
    }

    if (paybyRadio.value === "1") {
      if (
        cardNo1 === "" ||
        cardNo2 === "" ||
        cardNo3 === "" ||
        cardNo4 === ""
      ) {
        alert("ì¹´ë“œë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      if (cardGb === "INICIS" && birthDt === "") {
        alert("ê°œì¸ì¹´ë“œ/ê¸°ì—…ì¹´ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      if (cardM === "" || cardY === "") {
        alert("ìœ íš¨ê¸°ê°„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      if (pwd === "" && selectCard.value !== 0) {
        alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      if (cardIns == "") {
        alert("í• ë¶€ ê°œì›”ì„ ì„ íƒí•˜ì—¬ ì£¼ì‹­ì‹œì˜¤.");
        return;
      }
    }
  }

  cardInfo.value.cardNo = cardNo1 + cardNo2 + cardNo3 + cardNo4;
  cardInfo.value.expMm = cardM;
  cardInfo.value.expYy = cardY;

  if (paybyRadio.value === "1") {
    /** ì¼ë°˜ê²°ì œ **/
    // ë¹„ë°€ë²ˆí˜¸ ì²´í¬
    if (selectCard.value !== 0) {
      try {
        await api.get("/payment/pwdChk", { params: cardInfo.value });
      } catch (error) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }
    }

    try {
      if (!confirm("ê²°ì œë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      await api.post("/payment/reqPayment", cardInfo.value);

      //util.showNotify("ì •ìƒì²˜ë¦¬ ë˜ì—ˆìŠµë‹ˆë‹¤.");
      alert("ì •ìƒì²˜ë¦¬ ë˜ì—ˆìŠµë‹ˆë‹¤.");
      initCardInfo();
    } catch (error) {
      alert(error.response.data);

      // initCardInfo();
    }
  } else if (paybyRadio.value === "2") {
    /** ê°„í¸ê²°ì œ **/

    if (window.location.href.startsWith("https") === false) {
      alert(
        "ê°„í¸ê²°ì œì‹œì—ëŠ” https://www.ibjp.co.kr (ë³´ì•ˆURL)ë¡œ ì ‘ê·¼í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤."
      );
      return;
    }

    // Wpay user Key ì¡°íšŒ
    searchParam.value.cardGb = cardInfo.value.simplCardGb;
    const res = await api.get("/payment/wPayUserKey", {
      params: searchParam.value,
    });

    if (res.WPAY_USER_KEY === "") {
      let msg = `ê°„í¸ê²°ì œë¥¼ ì´ìš©í•˜ì‹œë ¤ë©´\n`;
      msg += `ìµœì´ˆ 1íšŒ íšŒì›ê°€ì…ì´ í•„ìš”í•©ë‹ˆë‹¤.\n`;
      msg += `íšŒì› ê°€ì…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

      if (!confirm(msg)) return;
      makeNewWindow();
    } else {
      makeNewWindow();
    }
  } else if (paybyRadio.value === "3") {
    // ë„¤ì´ë²„í˜ì´

    const OpenOption =
      "toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=900,height=650,top=100,left=400,";
    //const popup = window.open("kakaoPay", "PayForm", OpenOption);
    const popup = window.open("naverPay", "PayForm", OpenOption);

    document.getElementById("kakaoForm").submit();
  }

  bus.emit("initPmntAmt");
}

// ì»¤ì„œì´ë™
function autoMove(val, maxLength, nowField) {
  if (val.length === maxLength) {
    if (nowField === "card1") {
      card2.value.focus();
    } else if (nowField === "card2") {
      card3.value.focus();
    } else if (nowField === "card3") {
      card4.value.focus();
    } else if (nowField === "card4") {
      cardMonth.value.focus();
    } else if (nowField === "cardMonth") {
      cardYear.value.focus();
    } else if (nowField === "cardYear") {
      cardIns.value.focus();
    }
  }
}

watch(selectCard, () => {
  initCardInfo();
});

onMounted(async () => {
  await fetchData();

  if (!util.isEmpty(route.query.MSG)) {
    const paymentMSG =
      route.query.MSG == "success"
        ? "ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
        : "ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.";

    util.alert("í™•ì¸", paymentMSG, function () {
      router.push({ path: "/payment" });
    });
  }

  //ìì‹ì°½ì—ì„œ ë„˜ì–´ì˜¤ëŠ” ê±° í™•ì¸
  window.addEventListener("message", (e) => {
    // ë¶€ëª¨ì°½ì˜ í•¨ìˆ˜ ì‹¤í–‰
    if (e.data.functionName === "inicisClose") {
      util.alert("í™•ì¸", "ê²°ì œë¥¼ ì·¨ì†Œí•˜ì˜€ìŠµë‹ˆë‹¤.", function () {
        router.go(router.currentRoute);
      });
    }
  });
});

const onUpdate = async (val) => {
  selectCard.value = val;
  if (selectCard.value === 0) return;

  searchParam.value.sno = selectCard.value;

  const res = await api.get("/payment/myCardDtl", {
    params: searchParam.value,
  });

  const cardNoDec = res.CARD_NO;

  cardInfo.value.cardGb = res.PG_GB;
  cardInfo.value.cardNo1 = cardNoDec.substr(0, 4);
  cardInfo.value.cardNo2 = cardNoDec.substr(4, 4);
  cardInfo.value.cardNo3 = cardNoDec.substr(8, 4);
  cardInfo.value.cardNo4 = cardNoDec.substr(12, 4);
  cardInfo.value.cardM = res.EXP_MM;
  cardInfo.value.cardY = res.EXP_YY;
};
</script>

<style lang="scss" scoped>
$dt-w: 70px;
$dt-w2: 130px;

.paymentTable_1a {
  // height: 320px;
  height: 360px;
  @media screen and (max-width: 830px) {
    height: auto;
  }
}
.paySub_header_wrap {
  @include flex_between;
  align-items: center;
  margin-top: 8px;
  padding: 10px 8px;
  border-top: 1px solid $th-line;
  border-bottom: 1px solid $th-line;
  // .paySub_left {
  //   width: 100%;
  // }
}
.payby_wrap,
.payby_card {
  @include flex_start;
  // gap: 14px;
}
.payby_wrap {
  margin-bottom: 12px;
}
.payby_title {
  @include fs-5;
  @include fw-6;
  // width: 84px;
  width: $dt-w;
}
.card_select_wrap {
  // width: 400px;
  width: 150px !important;
}
.paySub_right {
  @include flex_end;
  gap: 8px;
  flex-wrap: wrap;
}

.paymentTable_wrap {
  // background-color: #eeeeee;
  // border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  //border-bottom: 1px solid $line-300;
  padding: 10px 8px;
}

.paymentTable_wrap > ul > li {
  display: flex;
  flex-direction: column;
  // gap: 12px;
}
// .paymentTable_wrap ul {
//   margin-bottom: 24px;
// }
.paymentTable_wrap ul:last-child {
  margin-bottom: 0;
}
.paymentTable_wrap li {
  @include fs-5;
  color: #000;
}
.paymentTable_wrap ul li ul {
  @include flex_start;
  height: 32px;
}
.paymentTable_wrap ul li ul + ul {
  margin-top: 12px;
}
.paymentTable_wrap ul li ul:last-child {
  @include flex_end;
  li {
    padding: 0;
    text-align: right;
  }
}
.paymentTable_wrap ul li ul li:nth-child(1) {
  width: 130px;
}
// .paymentTable_wrap ul li ul li:nth-child(3) {
//   width: 90px;
// }
.paymentTable_wrap ul li ul li:nth-child(2),
.paymentTable_wrap ul li ul li:nth-child(4) {
  // min-width: 200px;
  max-width: 400px;
  padding: 0 8px;
}
.paymentTable_wrap ul li ul li span {
  @include fs-6;
  color: #000;
}

.q-option-group {
  display: flex;
  gap: 16px;
  // flex-wrap: wrap;
  @media screen and (max-width: 1330px) {
    gap: 0;
    width: calc(100% + 32px);
  }
}

.cardWrap {
  display: flex;
  flex-wrap: wrap;
  flex-direction: column;
  gap: 10px 0;
  .q-option-group {
    flex-wrap: wrap;
  }
  dl {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    @include fs-5;
    dt {
      width: $dt-w;
      font-weight: bold;
    }
    dd {
      display: inline-flex;
      width: calc(100% - #{$dt-w});
      flex-wrap: wrap;
      gap: 0 3px;
      @media screen and (min-width: 831px) {
        .q-input {
          max-width: 100px;
        }
      }
    }
    &:has(> dd:nth-child(4)) {
      dd:nth-child(2) {
        width: calc(45% - #{$dt-w});
      }
      dt:nth-child(3) {
        width: $dt-w2;
      }
      dd:nth-child(4) {
        width: calc(55% - #{$dt-w2});
      }
    }
    &:has(input:not([type="radio"])) {
      min-height: 32px;
    }
  }
  .card_alert {
    margin-top: -8px;
    dd:nth-child(2) {
      width: calc(45% - #{$dt-w});
    }
    dd:nth-child(3) {
      width: auto;
      @include fs-6;
      color: #000;
    }
  }
  .card_num {
    dd {
      flex-wrap: nowrap;
    }
  }
  .btnArea {
    text-align: right;
  }
}
</style>
